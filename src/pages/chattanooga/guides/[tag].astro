---
import Card from '../../../components/Card.astro';
import Nav from '../../../components/Nav.astro';
import BaseHead from '../../../components/Head/BaseHead.astro';

export async function getStaticPaths() {
  const allPosts = (await Astro.glob('../../**/*.mdx')).filter(
    (post) => post.frontmatter.published !== false
  );
  // Extract tags with type "guide" and create a Set to ensure uniqueness
  const tagSet = new Set(allPosts.flatMap(post =>
  post.frontmatter.tags
    ? post.frontmatter.tags
        .filter(tagObject => tagObject.type === "guide")
        .map(tagObject => tagObject.tag)
    : []  // Return an empty array if there are no tags
));
  const tags = Array.from(tagSet).filter((element): element is string => element !== undefined);

  // Create paths for each tag
  const paths = tags.map(tag => {
    return {
      params: { tag }
    };
  });

  return paths;
}

const { tag } = Astro.params;

// Since we cannot share allPosts between getStaticPaths and the component,
// we need to fetch them again here for filtering
let filteredGuides = (await Astro.glob('../../**/*.mdx')).filter(post => post.frontmatter.published !== false && post.frontmatter.tags && post.frontmatter.tags.find(postTag => postTag.tag === tag));
let filteredEvents = (await Astro.glob('../../**/**/*.mdx')).filter(post => post.frontmatter.published !== false && post.frontmatter.tags && post.frontmatter.tags.find(postTag => postTag.tag === tag));

// Deduplicate posts by URL since both globs can match the same files
const postsMap = new Map();
[...filteredGuides, ...filteredEvents].forEach(post => {
  postsMap.set(post.url, post);
});
let filteredPosts = Array.from(postsMap.values());

const description = 'An easier way to find  things to do in greater Chattanooga';
const title = 'thingshappening';
const seoDescription = 'An easier way to find  things happening';

let allPostsIncludingMultipleDates = [];
filteredPosts.forEach((p) => {
  let baseData = Object.assign({}, p.frontmatter, {url: p.url});  // Create a copy of the base data

  if (baseData.eventDates) {
    baseData.eventDates.forEach((date, i) => {
      const again = Object.assign({}, baseData, {pubDate: date, title: `${baseData.title}`, url: `${baseData.url}/${date}`});

      allPostsIncludingMultipleDates.push(again);
    })
  } else {
    allPostsIncludingMultipleDates.push(baseData); // Push base data if no eventDates
  }
});
---

<html>
  <head>
    <BaseHead title={title} description={seoDescription} />
    <meta charset="utf-8" />
  </head>
  <body class=" text-black font-body leading-normal personality-casual">
    <Nav />

    <main>
      <article class="w-full px-4 md:px-8 lg:px-16 mt-8">
        <header class="pt-10 content">
          <h1 class="font-jakarta font-normal text-5xl">Explore <span class="text-customGreen1">Chattanooga</span> Like a Local with Our Guides<span class="text-customGreen1">.</span></h1>
        </header>
        <nav class="flex gap-6 pt-6 text-xl">
          <a href="/" class="text-gray-600 hover:text-customGreen1 pb-1 border-b-2 border-transparent hover:border-customGreen1 transition-colors">All</a>
          <a href="/chattanooga/guides/longform" class={tag === 'longform' ? 'text-customGreen1 font-semibold border-b-2 border-customGreen1 pb-1' : 'text-gray-600 hover:text-customGreen1 pb-1 border-b-2 border-transparent hover:border-customGreen1 transition-colors'}><span class="md:hidden">Longform</span><span class="hidden md:inline">Longform Guides</span></a>
          <a href="/chattanooga/editorials" class="text-gray-600 hover:text-customGreen1 pb-1 border-b-2 border-transparent hover:border-customGreen1 transition-colors">Editorials</a>
        </nav>

        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-8 py-8" data-test="articles-section">
          {allPostsIncludingMultipleDates.map(p => <div class="col-span-1">
            <Card post={p} highlighted={tag} />
          </div>)}
        </section>
      </article>
    </main>
  </body>
</html>
