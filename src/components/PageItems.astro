---
export interface Props {
  items: Array<{
    title: string;
    description: string;
    number: number;
    tags: string[];
    photoOptions?: {
      photos: string[];
      appearance?: 'before' | 'after' | 'inline';
    };
    links?: Array<{
      text: string;
      link: string;
      target?: string;
    }>;
  }>;
  showClearFilters?: boolean;
}

const { items, showClearFilters = false } = Astro.props;
const sortedItems = items.sort((a, b) => a.number - b.number);

// Get filter from URL query params
const activeTag = Astro.url.searchParams.get('tags') || null;
const filteredItems = activeTag 
  ? sortedItems.filter(item => item.tags.includes(activeTag))
  : sortedItems;

// Get current URL without query params for clear filters link
const currentPath = Astro.url.pathname;
---

<div class="max-w-6xl mx-auto px-3 mb-5">
  {showClearFilters && (
    <div class="mb-4 mt-4">
      <a href={currentPath} id="page-items-clear-filters" class={`px-5 py-2 text-white rounded-full text-sm transition-colors cursor-pointer inline-block ${activeTag ? '' : 'hidden'}`} style="background-color: #1a4d2e;">
        Clear filters
      </a>
    </div>
  )}
  
  {filteredItems.map((item) => (
    <section class="page-item text-xl pb-7" data-tags={item.tags.join(',')}>
      <div>
        {item.photoOptions && item.photoOptions.photos && item.photoOptions.photos.length > 0 && item.photoOptions.appearance === 'before' && (
          <div class="pb-5">
            <div class="flex flex-wrap gap-4">
              {item.photoOptions.photos.map((photo) => (
                <img src={photo} alt={item.title} class="rounded-xl max-w-md h-auto object-cover" loading="lazy" />
              ))}
            </div>
          </div>
        )}
        <h2 class="text-3xl mb-2" style="font-family: 'Libre Baskerville', serif;">
          <span class="text-gray-500 font-normal mr-2">{item.number}.</span>
          {item.title}
          <span class="color-pink ml-1"><b>.</b></span>
        </h2>
        <div class="pb-5">
          {item.description}
        </div>
        {item.links && item.links.length > 0 && (
          <div class="pb-5">
            <div class="flex flex-wrap gap-4">
              {item.links.map((link) => (
                <a href={link.link} target={link.target || '_blank'} rel={link.target === '_blank' ? 'noopener noreferrer' : undefined} class="page-item-link text-logoDarkGreen underline">
                  {link.text}
                </a>
              ))}
            </div>
          </div>
        )}
        {item.photoOptions && item.photoOptions.photos && item.photoOptions.photos.length > 0 && item.photoOptions.appearance === 'inline' && (
          <div class="pb-5">
            <div class="flex flex-wrap gap-4">
              {item.photoOptions.photos.map((photo) => (
                <img src={photo} alt={item.title} class="rounded-xl max-w-md h-auto object-cover" loading="lazy" />
              ))}
            </div>
          </div>
        )}
        <div class="pb-5">
          <div class="flex flex-wrap gap-2">
            {item.tags.map((tag) => {
              const isActive = activeTag === tag;
              const tagUrl = isActive ? currentPath : `${currentPath}?tags=${tag}`;
              return (
                <a href={tagUrl} class="page-item-tag px-5 py-2 text-white rounded-full text-sm cursor-pointer transition-colors font-normal no-underline" style={`background-color: ${isActive ? '#3CB371' : '#1a4d2e'};`} data-tag={tag}>
                  #{tag}
                </a>
              );
            })}
          </div>
        </div>
        {item.photoOptions && item.photoOptions.photos && item.photoOptions.photos.length > 0 && (item.photoOptions.appearance === 'after' || !item.photoOptions.appearance) && (
          <div class="pb-5">
            <div class="flex flex-wrap gap-4">
              {item.photoOptions.photos.map((photo) => (
                <img src={photo} alt={item.title} class="rounded-xl max-w-md h-auto object-cover" loading="lazy" />
              ))}
            </div>
          </div>
        )}
      </div>
    </section>
  ))}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tagLinks = document.querySelectorAll('.page-item-tag');
    const clickableFilterTags = document.querySelectorAll('.clickable-filter-tag');
    const pageItems = document.querySelectorAll('.page-item');
    const currentUrl = new URL(window.location.href);
    const activeTag = currentUrl.searchParams.get('tags');
    
    // Helper function to update all tag highlights
    function updateTagHighlights(tag) {
      // Update page-item tags
      tagLinks.forEach(t => {
        const tagValue = t.getAttribute('data-tag');
        if (tagValue === tag) {
          t.style.backgroundColor = '#3CB371';
        } else {
          t.style.backgroundColor = '#1a4d2e';
        }
      });
      
      // Update clickable filter tags
      clickableFilterTags.forEach(t => {
        const tagValue = t.getAttribute('data-tag');
        if (tagValue === tag) {
          t.style.backgroundColor = '#3CB371';
        } else {
          t.style.backgroundColor = '#1a4d2e';
        }
      });
    }
    
    // Highlight tags on initial load
    if (activeTag) {
      updateTagHighlights(activeTag);
    }
    
    // Handle page-item tag clicks
    tagLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const tag = this.getAttribute('data-tag');
        const currentUrl = new URL(window.location.href);
        const currentTag = currentUrl.searchParams.get('tags');
        let newTag = null;
        
        if (currentTag === tag) {
          // Remove filter if clicking the same tag
          currentUrl.searchParams.delete('tags');
        } else {
          // Set new filter
          currentUrl.searchParams.set('tags', tag);
          newTag = tag;
        }
        
        // Update URL without page reload
        window.history.pushState({}, '', currentUrl.toString());
        
        // Filter items client-side
        pageItems.forEach(item => {
          const itemTags = item.getAttribute('data-tags');
          if (!newTag || itemTags.includes(newTag)) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
        
        // Update all tag highlights
        updateTagHighlights(newTag);
        
        // Update clear filters button
        const clearBtn = document.getElementById('page-items-clear-filters');
        if (clearBtn) {
          if (newTag) {
            clearBtn.classList.remove('hidden');
          } else {
            clearBtn.classList.add('hidden');
          }
        }
      });
    });
    
    // Handle clickable filter tag clicks
    clickableFilterTags.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const tag = this.getAttribute('data-tag');
        const currentUrl = new URL(window.location.href);
        const currentTag = currentUrl.searchParams.get('tags');
        let newTag = null;
        
        if (currentTag === tag) {
          // Remove filter if clicking the same tag
          currentUrl.searchParams.delete('tags');
        } else {
          // Set new filter
          currentUrl.searchParams.set('tags', tag);
          newTag = tag;
        }
        
        // Update URL without page reload
        window.history.pushState({}, '', currentUrl.toString());
        
        // Filter items client-side
        pageItems.forEach(item => {
          const itemTags = item.getAttribute('data-tags');
          if (!newTag || itemTags.includes(newTag)) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
        
        // Update all tag highlights
        updateTagHighlights(newTag);
        
        // Update clear filters button
        const clearBtn = document.getElementById('page-items-clear-filters');
        if (clearBtn) {
          if (newTag) {
            clearBtn.classList.remove('hidden');
          } else {
            clearBtn.classList.add('hidden');
          }
        }
      });
    });
    
    // Clear filters button handler
    const clearBtn = document.getElementById('page-items-clear-filters');
    if (clearBtn) {
      clearBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.delete('tags');
        window.history.pushState({}, '', currentUrl.toString());
        
        // Show all items
        pageItems.forEach(item => {
          item.style.display = '';
        });
        
        // Reset all tag highlights
        updateTagHighlights(null);
        
        // Hide clear button
        clearBtn.classList.add('hidden');
      });
    }
  });
</script>

<style>
  .page-item-tag:hover,
  .clickable-filter-tag:hover {
    background-color: #3CB371 !important;
  }
  .page-item-link {
    text-decoration-color: #3CB371;
  }
</style>
